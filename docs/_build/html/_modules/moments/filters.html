

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>moments.filters &mdash; Moments 2.0 documentation</title>
    
    <link rel="stylesheet" href="../../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '2.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <link rel="top" title="Moments 2.0 documentation" href="../../index.html" />
    <link rel="up" title="Module code" href="../index.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../index.html">Moments 2.0 documentation</a> &raquo;</li>
          <li><a href="../index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <h1>Source code for moments.filters</h1><div class="highlight"><pre>
<span class="c">#!/usr/bin/env python</span>
<span class="c"># -*- coding: latin-1 -*-</span>
<span class="c"># ----------------------------------------------------------------------------</span>
<span class="c"># moments</span>
<span class="c"># Copyright (c) 2009-2011, Charles Brandt</span>
<span class="c"># </span>
<span class="c"># Permission is hereby granted, free of charge, to any person obtaining a copy</span>
<span class="c"># of this software and associated documentation files (the &quot;Software&quot;), to deal</span>
<span class="c"># in the Software without restriction, including without limitation the rights</span>
<span class="c"># to use, copy, modify, merge, publish, distribute, sublicense, and/or sell</span>
<span class="c"># copies of the Software, and to permit persons to whom the Software is</span>
<span class="c"># furnished to do so, subject to the following conditions:</span>
<span class="c"># </span>
<span class="c"># The above copyright notice and this permission notice shall be included in</span>
<span class="c"># all copies or substantial portions of the Software.</span>
<span class="c"># </span>
<span class="c"># THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR</span>
<span class="c"># IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,</span>
<span class="c"># FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE</span>
<span class="c"># AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER</span>
<span class="c"># LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,</span>
<span class="c"># OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN</span>
<span class="c"># THE SOFTWARE.</span>
<span class="c"># ----------------------------------------------------------------------------</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">functions useful for extracting moments from a group of log files</span>
<span class="sd">based on the tags we want to extract</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">unicodedata</span><span class="o">,</span> <span class="nn">sys</span>

<span class="kn">from</span> <span class="nn">moments.journal</span> <span class="kn">import</span> <span class="n">Journal</span>
<span class="kn">from</span> <span class="nn">moments.path</span> <span class="kn">import</span> <span class="n">Path</span><span class="p">,</span> <span class="n">check_ignore</span><span class="p">,</span> <span class="n">load_journal</span>
<span class="kn">from</span> <span class="nn">moments.timestamp</span> <span class="kn">import</span> <span class="n">Timestamp</span>

<div class="viewcode-block" id="omit_date_tags"><a class="viewcode-back" href="../../api/filters.html#moments.filters.omit_date_tags">[docs]</a><span class="k">def</span> <span class="nf">omit_date_tags</span><span class="p">(</span><span class="n">items</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    take a list of tags</span>
<span class="sd">    leave out any that are a timestamp</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">new_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">months</span> <span class="o">=</span> <span class="p">[</span> <span class="s">&quot;01&quot;</span><span class="p">,</span> <span class="s">&quot;02&quot;</span><span class="p">,</span> <span class="s">&quot;03&quot;</span><span class="p">,</span> <span class="s">&quot;04&quot;</span><span class="p">,</span> <span class="s">&quot;05&quot;</span><span class="p">,</span> <span class="s">&quot;06&quot;</span><span class="p">,</span> <span class="s">&quot;07&quot;</span><span class="p">,</span> <span class="s">&quot;08&quot;</span><span class="p">,</span> <span class="s">&quot;09&quot;</span><span class="p">,</span> <span class="s">&quot;10&quot;</span><span class="p">,</span> <span class="s">&quot;11&quot;</span><span class="p">,</span> <span class="s">&quot;12&quot;</span> <span class="p">]</span> 
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">items</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">t</span> <span class="o">=</span> <span class="n">Timestamp</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">months</span><span class="p">:</span>
                <span class="n">new_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">new_list</span>
</div>
<div class="viewcode-block" id="filter_list"><a class="viewcode-back" href="../../api/filters.html#moments.filters.filter_list">[docs]</a><span class="k">def</span> <span class="nf">filter_list</span><span class="p">(</span><span class="n">items</span><span class="p">,</span> <span class="n">ignores</span><span class="p">,</span> <span class="n">search</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    IF SEARCH IS NOT TRUE, IGNORES MUST BE AN EXACT MATCH</span>
<span class="sd">    </span>
<span class="sd">    take a list of items</span>
<span class="sd">    take a list of itmes to ignore</span>
<span class="sd">    return a new list of items based on first, original, with ignores removed</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">ignores</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">items</span><span class="p">:</span>
            <span class="n">items</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">search</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">items</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
                    <span class="n">items</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c">#must not match</span>
            <span class="k">pass</span>
    <span class="k">return</span> <span class="n">items</span>
</div>
<div class="viewcode-block" id="filter_entries"><a class="viewcode-back" href="../../api/filters.html#moments.filters.filter_entries">[docs]</a><span class="k">def</span> <span class="nf">filter_entries</span><span class="p">(</span><span class="n">journal</span><span class="p">,</span> <span class="n">updates</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    apply filters to the journal&#39;s entries in place</span>
<span class="sd">    #normalize/filter all of the data first...</span>
<span class="sd">    #as the system changes, so do the paths</span>

<span class="sd">    adapted from medialist.from_journal</span>

<span class="sd">    could consider adding this as a method to entry or data</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">journal</span><span class="p">:</span>
        <span class="n">filtered_data</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">e</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">splitlines</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">line</span><span class="p">:</span>
                <span class="c">#for url quoted items??</span>
                <span class="c">#item = urllib.unquote(item)</span>

                <span class="p">[</span><span class="n">line</span><span class="p">]</span> <span class="o">=</span> <span class="n">find_and_replace</span><span class="p">(</span> <span class="p">[</span><span class="n">line</span><span class="p">],</span> <span class="n">updates</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">line</span><span class="p">:</span>
                    <span class="n">filtered_data</span> <span class="o">+=</span> <span class="n">line</span> <span class="o">+</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span>

        <span class="n">e</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">filtered_data</span>
        <span class="c">#new_entries.append(e)</span>

</div>
<div class="viewcode-block" id="filter_log"><a class="viewcode-back" href="../../api/filters.html#moments.filters.filter_log">[docs]</a><span class="k">def</span> <span class="nf">filter_log</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">filters</span><span class="p">,</span> <span class="n">save</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">,</span> <span class="s">&quot;path must be a file, got: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">path</span>

    <span class="c">#j = Journal()</span>
    <span class="c">#j.load(path)</span>
    <span class="n">j</span> <span class="o">=</span> <span class="n">load_journal</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    
    <span class="n">j</span><span class="o">.</span><span class="n">filter_entries</span><span class="p">(</span><span class="n">filters</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">save</span><span class="p">:</span>
        <span class="c">#when it&#39;s time to save:</span>
        <span class="n">j</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="filter_logs"><a class="viewcode-back" href="../../api/filters.html#moments.filters.filter_logs">[docs]</a><span class="k">def</span> <span class="nf">filter_logs</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">updates</span><span class="o">=</span><span class="p">[],</span> <span class="n">save</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    walk the path, looking for moment logs</span>
<span class="sd">    for each log</span>
<span class="sd">    scan entries</span>
<span class="sd">    for each entry</span>
<span class="sd">    apply filter</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="n">add_tags</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">ignore_dirs</span> <span class="o">=</span> <span class="p">[</span> <span class="p">]</span>
    <span class="n">log_check</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">&#39;.*\.txt$&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">root</span><span class="p">,</span><span class="n">dirs</span><span class="p">,</span><span class="n">files</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">log_check</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
                    <span class="k">continue</span>
                
                <span class="n">cur_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">check_ignore</span><span class="p">(</span><span class="n">cur_file</span><span class="p">,</span> <span class="n">ignore_dirs</span><span class="p">):</span>
                    <span class="n">filter_log</span><span class="p">(</span><span class="n">cur_file</span><span class="p">,</span> <span class="n">updates</span><span class="p">,</span> <span class="n">save</span><span class="p">)</span>
                        
    <span class="k">elif</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="ow">and</span> <span class="n">log_check</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
        <span class="n">filter_log</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">updates</span><span class="p">,</span> <span class="n">save</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c">#no logs to scan</span>
        <span class="k">print</span> <span class="s">&quot;Unknown filetype sent as path: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">path</span>

    <span class="k">print</span> <span class="s">&quot;finished filtering&quot;</span>
</div>
<div class="viewcode-block" id="remove_dupes"><a class="viewcode-back" href="../../api/filters.html#moments.filters.remove_dupes">[docs]</a><span class="k">def</span> <span class="nf">remove_dupes</span><span class="p">(</span><span class="n">items</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    make sure no item appears twice in list</span>
<span class="sd">    i.e. filter for any duplicates</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">clean</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">items</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">clean</span><span class="p">:</span>
            <span class="n">clean</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">clean</span>
</div>
<div class="viewcode-block" id="union"><a class="viewcode-back" href="../../api/filters.html#moments.filters.union">[docs]</a><span class="k">def</span> <span class="nf">union</span><span class="p">(</span><span class="n">set1</span><span class="p">,</span> <span class="n">set2</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    take two lists</span>
<span class="sd">    union the items in them</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">combined</span> <span class="o">=</span> <span class="n">set1</span><span class="p">[:]</span>
    <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span> 
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">set2</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">combined</span><span class="p">:</span>
            <span class="n">combined</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">print</span> <span class="s">&quot;Found: </span><span class="si">%s</span><span class="s"> dupes&quot;</span> <span class="o">%</span> <span class="n">count</span>
    <span class="k">return</span> <span class="n">combined</span>
</div>
<div class="viewcode-block" id="intersect"><a class="viewcode-back" href="../../api/filters.html#moments.filters.intersect">[docs]</a><span class="k">def</span> <span class="nf">intersect</span><span class="p">(</span><span class="n">set1</span><span class="p">,</span> <span class="n">set2</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    take two lists</span>
<span class="sd">    intersect the items in them</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">both</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">set1</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">set2</span><span class="p">:</span>
            <span class="n">both</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">both</span>
</div>
<div class="viewcode-block" id="difference"><a class="viewcode-back" href="../../api/filters.html#moments.filters.difference">[docs]</a><span class="k">def</span> <span class="nf">difference</span><span class="p">(</span><span class="n">set1</span><span class="p">,</span> <span class="n">set2</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    take two lists</span>
<span class="sd">    return the differences</span>

<span class="sd">    NOTE THAT ORDER MATTERS!</span>
<span class="sd">    if 1 is a superset of 2, there will be a difference</span>
<span class="sd">    but if 2 is a superset of 1, there won&#39;t be a difference</span>

<span class="sd">    i.e.</span>
<span class="sd">    larger set first!</span>
<span class="sd">    larger = set1, smaller = set2</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">diff</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">set1</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">set2</span><span class="p">:</span>
            <span class="n">diff</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">diff</span>
</div>
<div class="viewcode-block" id="intersect_journal_entries_with_tags"><a class="viewcode-back" href="../../api/filters.html#moments.filters.intersect_journal_entries_with_tags">[docs]</a><span class="k">def</span> <span class="nf">intersect_journal_entries_with_tags</span><span class="p">(</span><span class="n">journal</span><span class="p">,</span> <span class="n">tag_list</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    look for all entries in the journal that have all tags in tag_list</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">entry_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">tag_list</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">journal</span><span class="o">.</span><span class="n">tag</span><span class="p">(</span><span class="n">tag</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">entry_set</span><span class="p">:</span>
                <span class="c">#must be our first one:</span>
                <span class="n">entry_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">journal</span><span class="o">.</span><span class="n">tag</span><span class="p">(</span><span class="n">tag</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c">#            time_set.intersect(set(l))</span>
                <span class="n">entry_set</span> <span class="o">=</span> <span class="n">entry_set</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">journal</span><span class="o">.</span><span class="n">tag</span><span class="p">(</span><span class="n">tag</span><span class="p">)))</span>
    <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">entry_set</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="union_journal_entries_with_tags"><a class="viewcode-back" href="../../api/filters.html#moments.filters.union_journal_entries_with_tags">[docs]</a><span class="k">def</span> <span class="nf">union_journal_entries_with_tags</span><span class="p">(</span><span class="n">journal</span><span class="p">,</span> <span class="n">tag_list</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    look for all entries in the journal that have any tags in tag_list</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">entry_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">tag_list</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">journal</span><span class="o">.</span><span class="n">tags</span><span class="p">(</span><span class="n">tag</span><span class="p">):</span>
            <span class="n">entry_set</span> <span class="o">=</span> <span class="n">entry_set</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">journal</span><span class="o">.</span><span class="n">tag</span><span class="p">(</span><span class="n">tag</span><span class="p">)))</span>
    <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">entry_set</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="union_journals"><a class="viewcode-back" href="../../api/filters.html#moments.filters.union_journals">[docs]</a><span class="k">def</span> <span class="nf">union_journals</span><span class="p">(</span><span class="n">journal</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    take another journal</span>
<span class="sd">    combine all entries in it and journal</span>

<span class="sd">    similar to merge_logs</span>
<span class="sd">    (to be consistent with intersect and difference behavior:</span>
<span class="sd">    return a new Journal with those entries)</span>

<span class="sd">    this is also what from_entries does</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">journal</span><span class="o">.</span><span class="n">from_entries</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="intersect_journals"><a class="viewcode-back" href="../../api/filters.html#moments.filters.intersect_journals">[docs]</a><span class="k">def</span> <span class="nf">intersect_journals</span><span class="p">(</span><span class="n">journal</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    take another journal,</span>
<span class="sd">    return a new journal</span>
<span class="sd">    with only the entries that are in common to both</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">common</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">other</span><span class="p">:</span>
        <span class="n">entry_time</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">entry</span><span class="o">.</span><span class="n">created</span><span class="p">)</span>
        <span class="n">matched</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">if</span> <span class="n">journal</span><span class="o">.</span><span class="n">dates</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="n">entry_time</span><span class="p">):</span>
            <span class="n">options</span> <span class="o">=</span> <span class="n">journal</span><span class="o">.</span><span class="n">dates</span><span class="p">[</span><span class="n">entry_time</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">options</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">existing</span> <span class="ow">in</span> <span class="n">options</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">existing</span><span class="o">.</span><span class="n">is_equal</span><span class="p">(</span><span class="n">entry</span><span class="p">):</span>
                <span class="n">common</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">existing</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">Journal</span><span class="p">(</span><span class="n">items</span><span class="o">=</span><span class="n">common</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="difference_journals"><a class="viewcode-back" href="../../api/filters.html#moments.filters.difference_journals">[docs]</a><span class="k">def</span> <span class="nf">difference_journals</span><span class="p">(</span><span class="n">journal</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    take another journal,</span>
<span class="sd">    return a new journal</span>
<span class="sd">    with the entries that are only in the other journal</span>
<span class="sd">    not in ourself</span>

<span class="sd">    NOTE:</span>
<span class="sd">    we may have entries in journal that are not in other...</span>
<span class="sd">    those will not be returned.</span>
<span class="sd">    this can be called in the opposite direction if those are wanted</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">diffs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">other</span><span class="p">:</span>
        <span class="n">entry_time</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">entry</span><span class="o">.</span><span class="n">created</span><span class="p">)</span>
        <span class="n">matched</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">if</span> <span class="n">journal</span><span class="o">.</span><span class="n">dates</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="n">entry_time</span><span class="p">):</span>
            <span class="n">options</span> <span class="o">=</span> <span class="n">journal</span><span class="o">.</span><span class="n">dates</span><span class="p">[</span><span class="n">entry_time</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">options</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">existing</span> <span class="ow">in</span> <span class="n">options</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">existing</span><span class="o">.</span><span class="n">is_equal</span><span class="p">(</span><span class="n">entry</span><span class="p">):</span>
                <span class="n">matched</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">matched</span><span class="p">:</span>
            <span class="n">diffs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">Journal</span><span class="p">(</span><span class="n">items</span><span class="o">=</span><span class="n">diffs</span><span class="p">)</span>


<span class="c">#UNTESTED BELOW HERE:</span>
</div>
<div class="viewcode-block" id="flatten"><a class="viewcode-back" href="../../api/filters.html#moments.filters.flatten">[docs]</a><span class="k">def</span> <span class="nf">flatten</span><span class="p">(</span><span class="n">journal</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    create a flat version of the journal without timestamps (or tags?)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">filename</span><span class="p">:</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">codecs</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s">&#39;utf-8&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">journal</span><span class="o">.</span><span class="n">path</span><span class="p">:</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">codecs</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">journal</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s">&#39;utf-8&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">print</span> <span class="s">&quot;No path to save file to&quot;</span>
        <span class="nb">exit</span><span class="p">()</span>

    <span class="n">flat</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
    <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">journal</span><span class="p">:</span>
        <span class="n">flat</span> <span class="o">+=</span> <span class="n">e</span><span class="o">.</span><span class="n">render_data</span><span class="p">()</span>

    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">flat</span><span class="p">)</span>
    <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="flatten_first_lines"><a class="viewcode-back" href="../../api/filters.html#moments.filters.flatten_first_lines">[docs]</a><span class="k">def</span> <span class="nf">flatten_first_lines</span><span class="p">(</span><span class="n">journal</span><span class="p">,</span> <span class="n">separator</span><span class="o">=</span><span class="s">&#39; &#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    only keep the first line of each journal entry</span>
<span class="sd">    useful for playlists</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">flat</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
    <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">journal</span><span class="p">:</span>
        <span class="n">flat</span> <span class="o">+=</span> <span class="n">e</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">separator</span>

    <span class="k">return</span> <span class="n">flat</span>

<span class="c"># not to be confused with association.filter_list</span></div>
<div class="viewcode-block" id="find_and_replace"><a class="viewcode-back" href="../../api/filters.html#moments.filters.find_and_replace">[docs]</a><span class="k">def</span> <span class="nf">find_and_replace</span><span class="p">(</span><span class="n">items</span><span class="p">,</span> <span class="n">updates</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    aka find_and_replace</span>
<span class="sd">    </span>
<span class="sd">    apply all updates in updates list </span>
<span class="sd">    to all items in items list</span>

<span class="sd">    updates consist of a list of lists</span>
<span class="sd">    where the sub lists contain:</span>
<span class="sd">    (search_string, replace_string)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">u</span> <span class="ow">in</span> <span class="n">updates</span><span class="p">:</span>
        <span class="n">search_string</span> <span class="o">=</span> <span class="n">u</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">replace_string</span> <span class="o">=</span> <span class="n">u</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="c">#print search_string</span>
        <span class="n">pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">search_string</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">items</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">pattern</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">item</span><span class="p">):</span>
                <span class="n">index</span> <span class="o">=</span> <span class="n">items</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
                <span class="n">items</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
                <span class="c">#print &quot;ORIGINAL ITEM: %s&quot; % item</span>

                <span class="n">item</span> <span class="o">=</span> <span class="n">pattern</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">replace_string</span><span class="p">,</span> <span class="n">item</span><span class="p">)</span>
                <span class="c"># not sure if python replace is faster than re.sub:</span>
                <span class="c">#journal.replace(pu[0], pu[1])</span>
                
                <span class="c">#print &quot;     NEW ITEM: %s&quot; % item</span>
                <span class="n">items</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">item</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">items</span>
</div>
<div class="viewcode-block" id="ExtractConfig"><a class="viewcode-back" href="../../api/filters.html#moments.filters.ExtractConfig">[docs]</a><span class="k">class</span> <span class="nc">ExtractConfig</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    used in /c/mindstream/moments-scripts/extract.py</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sources</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ignores</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">extractions</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
</div>
<div class="viewcode-block" id="extract"><a class="viewcode-back" href="../../api/filters.html#moments.filters.extract">[docs]</a><span class="k">def</span> <span class="nf">extract</span><span class="p">(</span><span class="n">journal</span><span class="p">,</span> <span class="n">tag_list</span><span class="p">,</span> <span class="n">etype</span><span class="o">=</span><span class="s">&quot;intersect&quot;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    remove any entries tagged with a/all tag in tag_list</span>

<span class="sd">    saving journal (with missing entries) left to caller (if desired)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">entries</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">etype</span> <span class="o">==</span> <span class="s">&quot;union&quot;</span><span class="p">:</span>
        <span class="n">entries</span> <span class="o">=</span> <span class="n">union_journal_entries_with_tags</span><span class="p">(</span><span class="n">journal</span><span class="p">,</span> <span class="n">tag_list</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">etype</span> <span class="o">==</span> <span class="s">&quot;intersect&quot;</span><span class="p">:</span>
        <span class="n">entries</span> <span class="o">=</span> <span class="n">intersect_journal_entries_with_tags</span><span class="p">(</span><span class="n">journal</span><span class="p">,</span> <span class="n">tag_list</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">print</span> <span class="s">&quot;Unknown type of extraction!!!&quot;</span>

    <span class="c">#sending fname creates place holder entries in the journal</span>
    <span class="c">#not sure if we still need to do that [2008.11.04 16:58]</span>
    <span class="c">#(dir, fname) = os.path.split(ofile)</span>
    <span class="c">#journal.remove_many(entries, fname)</span>
    <span class="n">journal</span><span class="o">.</span><span class="n">remove_many</span><span class="p">(</span><span class="n">entries</span><span class="p">)</span>

    <span class="c">#rather than save here, lets just return the list of entries</span>
    <span class="c">#then they can be added to another journal instance</span>
    <span class="c">#or written directly to log by caller as they were here.</span>
    <span class="k">return</span> <span class="n">entries</span>
</div>
<div class="viewcode-block" id="extract_many"><a class="viewcode-back" href="../../api/filters.html#moments.filters.extract_many">[docs]</a><span class="k">def</span> <span class="nf">extract_many</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">extractions</span><span class="p">,</span> <span class="n">ignores</span><span class="o">=</span><span class="p">[],</span> <span class="n">save</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">extract_type</span><span class="o">=</span><span class="s">&quot;intersect&quot;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    rather than go through all files for every extraction</span>
<span class="sd">    it is nice to go through all extractions during each file</span>

<span class="sd">    save extractions for each file</span>
<span class="sd">    rather than accumulating until end</span>

<span class="sd">    will make it trickier for trial runs</span>
<span class="sd">    can print actions or make temp logs</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">these_tags</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">filename_tags</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">path</span><span class="p">)</span><span class="o">.</span><span class="n">to_tags</span><span class="p">()</span>
    <span class="c">#print filename_tags</span>
    <span class="n">filename_tags</span> <span class="o">=</span> <span class="n">filter_list</span><span class="p">(</span><span class="n">filename_tags</span><span class="p">,</span> <span class="n">ignores</span><span class="p">,</span> <span class="n">search</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="c">#print filename_tags</span>
    <span class="n">filename_tags</span> <span class="o">=</span> <span class="n">omit_date_tags</span><span class="p">(</span><span class="n">filename_tags</span><span class="p">)</span>
    <span class="n">these_tags</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">filename_tags</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">,</span> <span class="s">&quot;path must be a file, got: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">path</span>
    <span class="n">j</span> <span class="o">=</span> <span class="n">Journal</span><span class="p">()</span>
    
    <span class="c">#j.load(path, add_tags=these_tags)</span>
    <span class="c">#can add tags to the export, but don&#39;t want to add them in here:</span>
    <span class="n">has_entries</span> <span class="o">=</span> <span class="n">j</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">tags</span><span class="p">,</span> <span class="n">destination</span><span class="p">)</span> <span class="ow">in</span> <span class="n">extractions</span><span class="p">:</span>
        <span class="n">entries</span> <span class="o">=</span> <span class="n">extract</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">tags</span><span class="p">,</span> <span class="n">extract_type</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">entries</span><span class="p">):</span>
            <span class="k">print</span> <span class="s">&quot;found </span><span class="si">%s</span><span class="s"> entries with tag: </span><span class="si">%s</span><span class="s"> in: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">entries</span><span class="p">),</span> <span class="n">tags</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
            <span class="n">entries</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span>
            <span class="n">j2</span> <span class="o">=</span> <span class="n">Journal</span><span class="p">()</span>
            <span class="n">j2</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">destination</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">entries</span><span class="p">:</span>
                <span class="n">e</span><span class="o">.</span><span class="n">tags</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">these_tags</span><span class="p">)</span>
                <span class="n">j2</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                <span class="n">entry</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">render</span><span class="p">()</span>
                <span class="n">e_ascii</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="n">unaccented_map</span><span class="p">())</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&quot;ascii&quot;</span><span class="p">,</span> <span class="s">&quot;ignore&quot;</span><span class="p">)</span>
                <span class="k">print</span> <span class="s">&quot;adding entry to: </span><span class="si">%s</span><span class="se">\n</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">destination</span><span class="p">,</span> <span class="n">e_ascii</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">save</span><span class="p">:</span>
                <span class="c">#this way we&#39;re saving any entries we extract to the new</span>
                <span class="c">#destination before we save the original source file</span>
                <span class="c">#</span>
                <span class="c">#if there are permission problems writing the source file</span>
                <span class="c">#at worst we&#39;ll have 2 copies of the same entry</span>
                <span class="c"># (and that can be filtered out later)</span>
                <span class="n">j2</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">destination</span><span class="p">)</span>

    <span class="c"># do *not* want to save if the file passed to the journal did not get parsed as having entries</span>
    <span class="c"># this would result in a blank file being saved,</span>
    <span class="c"># resulting in data loss, if the text file was not in a moments format</span>
    <span class="c"># i.e. check both if save is desired (&#39;save&#39; variable)</span>
    <span class="c"># and if journal had entries (&#39;has_entries&#39; variable)</span>
    <span class="k">if</span> <span class="n">save</span> <span class="ow">and</span> <span class="n">has_entries</span><span class="p">:</span>
        <span class="c">#when it&#39;s time to save:</span>
        <span class="n">j</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="extract_tags"><a class="viewcode-back" href="../../api/filters.html#moments.filters.extract_tags">[docs]</a><span class="k">def</span> <span class="nf">extract_tags</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">extractions</span><span class="o">=</span><span class="p">[],</span> <span class="n">ignores</span><span class="o">=</span><span class="p">[],</span> <span class="n">save</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                 <span class="n">extract_type</span><span class="o">=</span><span class="s">&#39;intersect&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    accept a list of extractions</span>
<span class="sd">    where each extraction consists of a set of tags to look for</span>
<span class="sd">    (using extract_type)</span>
<span class="sd">    and a destination where matching entries should be extracted to</span>

<span class="sd">    ignores is a list of tags to leave out of the found entries</span>
<span class="sd">    (good for filtering tags generated from the original file path)</span>
<span class="sd">    </span>
<span class="sd">    this duplicates the logic for scanning all files from extract_tag</span>
<span class="sd">    it feels more readable to separate the two</span>

<span class="sd">    *2009.08.29 13:20:46</span>
<span class="sd">    now part of the moments module itself</span>

<span class="sd">    not to be confused with the Journal.extract method</span>
<span class="sd">    these functions are higher level operations that utilize Journal.extract</span>

<span class="sd">    also:</span>
<span class="sd">    # take a list of tags,</span>
<span class="sd">    # and the directory or file that you want to use as the source of the tags</span>
<span class="sd">    # go through all files, and remove those tags</span>
<span class="sd">    # saving them in a new separate file (or specified existing file)</span>

<span class="sd">    # adapted from pose.controllers.tags.extract</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="n">add_tags</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">ignore_dirs</span> <span class="o">=</span> <span class="p">[</span> <span class="s">&#39;downloads&#39;</span><span class="p">,</span> <span class="s">&#39;binaries&#39;</span> <span class="p">]</span>
    <span class="n">log_check</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">&#39;.*\.txt$&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">root</span><span class="p">,</span><span class="n">dirs</span><span class="p">,</span><span class="n">files</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">log_check</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
                    <span class="k">continue</span>
                
                <span class="n">cur_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">check_ignore</span><span class="p">(</span><span class="n">cur_file</span><span class="p">,</span> <span class="n">ignore_dirs</span><span class="p">):</span>
                    <span class="n">extract_many</span><span class="p">(</span><span class="n">cur_file</span><span class="p">,</span> <span class="n">extractions</span><span class="p">,</span> <span class="n">ignores</span><span class="p">,</span> <span class="n">save</span><span class="p">,</span>
                                 <span class="n">extract_type</span><span class="p">)</span>
                        
    <span class="k">elif</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="ow">and</span> <span class="n">log_check</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
        <span class="n">extract_many</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">extractions</span><span class="p">,</span> <span class="n">ignores</span><span class="p">,</span> <span class="n">save</span><span class="p">,</span> <span class="n">extract_type</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c">#no logs to scan</span>
        <span class="k">print</span> <span class="s">&quot;Unknown filetype sent as path: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">path</span>

    <span class="c">#print &quot;finished extracting multiple tags to multiple destinations&quot;</span>


<span class="c"># use a dynamically populated translation dictionary to remove accents</span>
<span class="c"># from a string</span>
<span class="c">#</span>
<span class="c"># http://effbot.python-hosting.com/file/stuff/sandbox/text/unaccent.py</span>
<span class="c"># http://www.crummy.com/cgi-bin/msm/map.cgi/ASCII%2C+Dammit</span>
<span class="c"># http://www.peterbe.com/plog/unicode-to-ascii</span>
<span class="c"># see also phraseUnicode2ASCII()</span>

<span class="c"># Translation dictionary.  Translation entries are added to this</span>
<span class="c"># dictionary as needed.</span>
<span class="c">##</span></div>
<span class="n">CHAR_REPLACEMENT</span> <span class="o">=</span> <span class="p">{</span>
    <span class="c"># latin-1 characters that don&#39;t have a unicode decomposition</span>
    <span class="mh">0xc6</span><span class="p">:</span> <span class="s">u&quot;AE&quot;</span><span class="p">,</span> <span class="c"># LATIN CAPITAL LETTER AE</span>
    <span class="mh">0xd0</span><span class="p">:</span> <span class="s">u&quot;D&quot;</span><span class="p">,</span>  <span class="c"># LATIN CAPITAL LETTER ETH</span>
    <span class="mh">0xd8</span><span class="p">:</span> <span class="s">u&quot;OE&quot;</span><span class="p">,</span> <span class="c"># LATIN CAPITAL LETTER O WITH STROKE</span>
    <span class="mh">0xde</span><span class="p">:</span> <span class="s">u&quot;Th&quot;</span><span class="p">,</span> <span class="c"># LATIN CAPITAL LETTER THORN</span>
    <span class="mh">0xdf</span><span class="p">:</span> <span class="s">u&quot;ss&quot;</span><span class="p">,</span> <span class="c"># LATIN SMALL LETTER SHARP S</span>
    <span class="mh">0xe6</span><span class="p">:</span> <span class="s">u&quot;ae&quot;</span><span class="p">,</span> <span class="c"># LATIN SMALL LETTER AE</span>
    <span class="mh">0xf0</span><span class="p">:</span> <span class="s">u&quot;d&quot;</span><span class="p">,</span>  <span class="c"># LATIN SMALL LETTER ETH</span>
    <span class="mh">0xf8</span><span class="p">:</span> <span class="s">u&quot;oe&quot;</span><span class="p">,</span> <span class="c"># LATIN SMALL LETTER O WITH STROKE</span>
    <span class="mh">0xfe</span><span class="p">:</span> <span class="s">u&quot;th&quot;</span><span class="p">,</span> <span class="c"># LATIN SMALL LETTER THORN</span>
    <span class="p">}</span>


<div class="viewcode-block" id="unaccented_map"><a class="viewcode-back" href="../../api/filters.html#moments.filters.unaccented_map">[docs]</a><span class="k">class</span> <span class="nc">unaccented_map</span><span class="p">(</span><span class="nb">dict</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Maps a unicode character code (the key) to a replacement code</span>
<span class="sd">    (either a character code or a unicode string).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="nf">mapchar</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="n">ch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ch</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">ch</span>
        <span class="n">de</span> <span class="o">=</span> <span class="n">unicodedata</span><span class="o">.</span><span class="n">decomposition</span><span class="p">(</span><span class="nb">unichr</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">de</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">ch</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">de</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">16</span><span class="p">)</span>
            <span class="k">except</span> <span class="p">(</span><span class="ne">IndexError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">):</span>
                <span class="n">ch</span> <span class="o">=</span> <span class="n">key</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ch</span> <span class="o">=</span> <span class="n">CHAR_REPLACEMENT</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">ch</span>
        <span class="k">return</span> <span class="n">ch</span>

    <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">version</span> <span class="o">&gt;=</span> <span class="s">&quot;2.5&quot;</span><span class="p">:</span>
        <span class="c"># use __missing__ where available</span>
        <span class="n">__missing__</span> <span class="o">=</span> <span class="n">mapchar</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c"># otherwise, use standard __getitem__ hook (this is slower,</span>
        <span class="c"># since it&#39;s called for each character)</span>
        <span class="n">__getitem__</span> <span class="o">=</span> <span class="n">mapchar</span>

</div>
<span class="k">def</span> <span class="nf">to_ascii</span><span class="p">(</span><span class="n">source</span><span class="p">):</span>
    <span class="c">#print type(source)</span>
    <span class="c">#source = source.translate(unaccented_map()).encode(&quot;ascii&quot;, &quot;ignore&quot;)</span>
    <span class="n">source</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="n">unaccented_map</span><span class="p">())</span>
    <span class="k">return</span> <span class="n">source</span>

<span class="k">def</span> <span class="nf">to_unicode</span><span class="p">(</span><span class="n">source</span><span class="p">):</span>
    <span class="n">s</span> <span class="o">=</span> <span class="s">u&#39;&#39;</span>
    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">source</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">+=</span> <span class="nb">unicode</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>
    <span class="k">return</span> <span class="n">s</span>

<span class="k">def</span> <span class="nf">to_ascii2</span><span class="p">(</span><span class="n">source</span><span class="p">):</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">to_unicode</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">to_ascii</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">s</span>


<span class="k">def</span> <span class="nf">test_ascii</span><span class="p">():</span>

    <span class="n">text</span> <span class="o">=</span> <span class="s">u&quot;&quot;&quot;</span>

<span class="s">    &quot;Jo, når&#39;n da ha gått ett stôck te, så kommer&#39;n te e å,</span>
<span class="s">    å i åa ä e ö.&quot;</span>
<span class="s">    &quot;Vasa&quot;, sa&#39;n.</span>
<span class="s">    &quot;Å i åa ä e ö&quot;, sa ja.</span>
<span class="s">    &quot;Men va i all ti ä dä ni säjer, a, o?&quot;, sa&#39;n.</span>
<span class="s">    &quot;D&#39;ä e å, vett ja&quot;, skrek ja, för ja ble rasen, &quot;å i åa</span>
<span class="s">    ä e ö, hörer han lite, d&#39;ä e å, å i åa ä e ö.&quot;</span>
<span class="s">    &quot;A, o, ö&quot;, sa&#39;n å dämmä geck&#39;en.</span>
<span class="s">    Jo, den va nôe te dum den.</span>

<span class="s">    (taken from the short story &quot;Dumt fôlk&quot; in Gustaf Fröding&#39;s</span>
<span class="s">    &quot;Räggler å paschaser på våra mål tå en bonne&quot; (1895).</span>

<span class="s">    &quot;&quot;&quot;</span>

    <span class="k">print</span> <span class="n">text</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="n">unaccented_map</span><span class="p">())</span>

    <span class="c"># note that non-letters are passed through as is; you can use</span>
    <span class="c"># encode(&quot;ascii&quot;, &quot;ignore&quot;) to get rid of them.  alternatively,</span>
    <span class="c"># you can tweak the translation dictionary to return None for</span>
    <span class="c"># characters &gt;= &quot;\x80&quot;.</span>

    <span class="nb">map</span> <span class="o">=</span> <span class="n">unaccented_map</span><span class="p">()</span>

    <span class="k">print</span> <span class="nb">repr</span><span class="p">(</span><span class="s">u&quot;12</span><span class="se">\xbd</span><span class="s"> inch&quot;</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="nb">map</span><span class="p">))</span>
    <span class="k">print</span> <span class="nb">repr</span><span class="p">(</span><span class="s">u&quot;12</span><span class="se">\xbd</span><span class="s"> inch&quot;</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="nb">map</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&quot;ascii&quot;</span><span class="p">,</span> <span class="s">&quot;ignore&quot;</span><span class="p">))</span>


<div class="viewcode-block" id="main"><a class="viewcode-back" href="../../api/filters.html#moments.filters.main">[docs]</a><span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    *2011.08.30 09:09:19 </span>
<span class="sd">    imported from filter_logs</span>
<span class="sd">    that might not be the main functionality of this module</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">source</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">if</span> <span class="nb">len</span> <span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;--help&#39;</span><span class="p">,</span><span class="s">&#39;help&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">usage</span><span class="p">()</span>
        <span class="n">source</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="n">updates</span> <span class="o">=</span> <span class="p">[</span> <span class="p">[</span><span class="s">&#39;c\/media\/binaries&#39;</span><span class="p">,</span> <span class="s">&#39;c/binaries&#39;</span><span class="p">],</span>
                <span class="p">[</span><span class="s">&#39;^media\/&#39;</span><span class="p">,</span> <span class="s">&#39;/c/&#39;</span><span class="p">]</span>
                <span class="p">]</span>
    <span class="n">filter_logs</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">updates</span><span class="p">,</span> <span class="n">save</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</div>
<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../index.html">Moments 2.0 documentation</a> &raquo;</li>
          <li><a href="../index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2012, Charles Brandt.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.3.
    </div>
  </body>
</html>